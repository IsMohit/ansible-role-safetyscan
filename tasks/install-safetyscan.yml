---
- name: Install git
  package:
    name: git
    state: present

- name: Remove existing SafetyScan directory if force install
  file:
    path: "{{ safetyscan_install_dir }}"
    state: absent
  when: safetyscan_force_install

- name: Clone SafetyScan repository
  git:
    repo: "{{ safetyscan_repo_url }}"
    dest: "{{ safetyscan_install_dir }}"
    version: "{{ safetyscan_version }}"
    force: yes

- name: Make scripts executable
  file:
    path: "{{ safetyscan_install_dir }}/{{ item }}"
    mode: '0755'
  loop:
    - safetyscan.sh
    - report_generator.py

- name: Copy safetyscan to bin directory
  copy:
    src: "{{ safetyscan_install_dir }}/safetyscan.sh"
    dest: "{{ safetyscan_bin_dir }}/safetyscan"
    mode: '0755'
    remote_src: yes

- name: Copy report generator to bin directory (optional)
  copy:
    src: "{{ safetyscan_install_dir }}/report_generator.py"
    dest: "{{ safetyscan_bin_dir }}/safetyscan-report-generator"
    mode: '0755'
    remote_src: yes
  failed_when: false

- name: Check if Python 3 is available (for comprehensive reports)
  command: python3 --version
  register: python_check
  changed_when: false
  failed_when: false

- name: Display Python status
  debug:
    msg: "{{ 'Python 3 available - comprehensive reports will work' if python_check.rc == 0 else 'Python 3 not found - only basic reports will be generated' }}"