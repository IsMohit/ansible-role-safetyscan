---
- name: Create project-specific report directories
  file:
    path: "{{ safetyscan_report_base_dir }}/{{ item.name }}"
    state: directory
    owner: "{{ safetyscan_report_owner }}"
    group: "{{ safetyscan_report_group }}"
    mode: "{{ safetyscan_report_mode }}"
  loop: "{{ safetyscan_projects }}"
  when: item.enabled | default(true)

- name: Run SafetyScan for each project
  shell: |
    cd {{ item.path }}
    {% if item.mode in ['dast', 'both'] %}
    {{ safetyscan_bin_dir }}/safetyscan {{ item.path }} \
      --mode {{ item.mode }} \
      --start "{{ item.start_cmd }}" \
      --port {{ item.port }}
    {% else %}
    {{ safetyscan_bin_dir }}/safetyscan {{ item.path }} \
      --mode {{ item.mode }}
    {% endif %}
  loop: "{{ safetyscan_projects }}"
  when: item.enabled | default(true)
  async: "{{ safetyscan_scan_timeout }}"
  poll: "{{ 0 if safetyscan_concurrent_scans else 10 }}"
  register: scan_results
  changed_when: true

- name: Wait for concurrent scans to complete
  async_status:
    jid: "{{ item.ansible_job_id }}"
  register: scan_jobs
  until: scan_jobs.finished
  retries: "{{ (safetyscan_scan_timeout / 10) | int }}"
  delay: 10
  loop: "{{ scan_results.results }}"
  when:
  - safetyscan_concurrent_scans
  - item.ansible_job_id is defined

- name: Display scan results
  debug:
    msg: "Scan completed for project: {{ item.item.name }}"
  loop: "{{ scan_results.results }}"
  when: item.rc is defined and item.rc == 0

- name: Log scan failures
  debug:
    msg: "Scan failed for project: {{ item.item.name }} - {{ item.stderr | default('Unknown error') }}"
  loop: "{{ scan_results.results }}"
  when: item.rc is defined and item.rc != 0
