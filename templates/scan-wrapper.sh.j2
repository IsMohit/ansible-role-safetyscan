#!/bin/bash
# SafetyScan wrapper script for {{ item.name }}
# Generated by Ansible

set -euo pipefail

PROJECT_NAME="{{ item.name }}"
PROJECT_PATH="{{ item.path }}"
MODE="{{ item.mode }}"
{% if item.mode in ['dast', 'both'] %}
START_CMD="{{ item.start_cmd }}"
PORT="{{ item.port }}"
{% endif %}
REPORT_DIR="{{ safetyscan_report_base_dir }}/{{ item.name }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOG_FILE="{{ safetyscan_log_file }}"

echo "[$(date)] Starting SafetyScan for ${PROJECT_NAME}" >> "${LOG_FILE}"

# Run scan
{% if item.mode in ['dast', 'both'] %}
{{ safetyscan_bin_dir }}/safetyscan "${PROJECT_PATH}" \
  --mode "${MODE}" \
  --start "${START_CMD}" \
  --port "${PORT}" \
  2>&1 | tee -a "${LOG_FILE}"
{% else %}
{{ safetyscan_bin_dir }}/safetyscan "${PROJECT_PATH}" \
  --mode "${MODE}" \
  2>&1 | tee -a "${LOG_FILE}"
{% endif %}

SCAN_EXIT_CODE=$?

echo "[$(date)] SafetyScan completed for ${PROJECT_NAME} with exit code ${SCAN_EXIT_CODE}" >> "${LOG_FILE}"

# Send notification if enabled
{% if safetyscan_enable_notifications %}
if [ ${SCAN_EXIT_CODE} -ne 0 ] {% if safetyscan_notification_on_failure %}|| true{% endif %}; then
  {{ safetyscan_bin_dir }}/safetyscan-notify.sh "${PROJECT_NAME}" "${SCAN_EXIT_CODE}" "${REPORT_DIR}"
fi
{% endif %}

# Cleanup old reports
{% if safetyscan_cleanup_old_reports %}
find "${REPORT_DIR}" -type d -mtime +{{ safetyscan_report_retention_days }} -exec rm -rf {} + 2>/dev/null || true
{% endif %}

exit ${SCAN_EXIT_CODE}