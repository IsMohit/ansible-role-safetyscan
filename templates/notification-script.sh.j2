#!/bin/bash
# SafetyScan notification script
# Generated by Ansible

set -euo pipefail

PROJECT_NAME="${1:-unknown}"
EXIT_CODE="${2:-0}"
REPORT_DIR="${3:-unknown}"

{% if safetyscan_notification_slack_webhook %}
# Slack notification
send_slack_notification() {
  local color="good"
  local status="Success"
  
  if [ "${EXIT_CODE}" != "0" ]; then
    color="danger"
    status="Failed"
  fi
  
  curl -X POST -H 'Content-type: application/json' \
    --data "{
      \"attachments\": [{
        \"color\": \"${color}\",
        \"title\": \"SafetyScan ${status}: ${PROJECT_NAME}\",
        \"fields\": [
          {\"title\": \"Status\", \"value\": \"${status}\", \"short\": true},
          {\"title\": \"Exit Code\", \"value\": \"${EXIT_CODE}\", \"short\": true},
          {\"title\": \"Host\", \"value\": \"$(hostname)\", \"short\": true},
          {\"title\": \"Report\", \"value\": \"${REPORT_DIR}\", \"short\": false}
        ],
        \"footer\": \"SafetyScan\",
        \"ts\": $(date +%s)
      }]
    }" \
    {{ safetyscan_notification_slack_webhook }}
}

send_slack_notification
{% endif %}

{% if safetyscan_notification_email %}
# Email notification
send_email_notification() {
  local subject="SafetyScan Report: ${PROJECT_NAME}"
  local body="SafetyScan completed for ${PROJECT_NAME}\n\nExit Code: ${EXIT_CODE}\nReport Directory: ${REPORT_DIR}\nHost: $(hostname)\nTimestamp: $(date)"
  
  echo -e "${body}" | mail -s "${subject}" {{ safetyscan_notification_email }}
}

send_email_notification
{% endif %}

exit 0